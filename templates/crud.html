<!DOCTYPE html>

<!-- EXTEND (layout.html), this is a template for all rendered pages in the project -->
{% extends "layouts/base.html" %}

<!-- CONTENT (in <head>), content for this page -->
{% block meta %}
    <title>CRUD page</title>

    <!-- Password verification and error message -->
    <script>
        //adding dom event listener to allow the verifyPassword funtion to be attached to the form. This is so we can keep our JS separate from our html and not have onsubmit in the form.

        'use strict' //ensures best environment to prevent JS programmer error and tells browser to use most modern version of JS interpreter it has.

        document.addEventListener("DOMContentLoaded", function(){
            // event listener fires when the DOM is fully loaded. This way you can write scripts that are before the elements are loaded into the dom, but waits to be added to the page until the dom is fully loaded.

            document.querySelector('#create').addEventListener('submit', verifyPassword );
            //querySelector selects elements with CSS selectors. id="create" gets selected with the code above.

            // pulled this function in here to keep it private from the window object/global scope. This is one way to protect your variables and functions from being hijacked by xss. Declared function names do act like variables in a way.

            function verifyPassword(event) {
                /*
                because this is being called by an event, the event object is automatically
                passed and captured as seen above. We are capturing it with the 'event' parameter in this function.
                This is frequently represented in the following ways in JS: e, evt and event.
                As a variable, it could be called anything - but it makes more sense to call it event rather than banana... etc.
                Name your variables well, my friends.
                */

                const psw =  document.getElementById("password").value;

                if (psw.length < 6 || psw.length > 20) {
                    document.getElementById("pswError").innerHTML = "Password must be between 6 and 20 characters";
                    event.preventDefault();
                    //prevents submission of form when password length is not valid.
                }

            } //this function could be expanded upon, where we use JS to completely validate the form and have HTML5 as a fallback. Let me know if you want to have me expand this. - T

            //additional listeners and functions could/should be put in here.

        }); //end DOMContentLoaded listener

    </script>
{% endblock %}

<!-- CONTENT (in <body>), content for this page -->
{% block body %}
    <div class="container py-4 text-light bg-success">

        <div class="container py-4">
            <div class="p-5 mb-4 bg-light text-dark rounded-3">
                <h2>Share Your Advice</h2>
                <div class="row align-items-md-stretch">
                    <table class="table">
                        <tbody>
                        <tr>
                            <td></td>
                            <td></td>
                            <td><a href={{url_for('crud.crud')}}>Full Table </a></td>
                            <td><a href="https://github.com/nighthawkcoders/nighthawk_csp/tree/master/crud">GitHub Source</a></td>
                            <td><a href="{{url_for('crud.search')}}">Search</a></td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="row align-items-md-stretch">
                    <div class="container-fluid py-5">
                        <table class="table">
                            <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Grade</th>
                                <th>Advice</th>
                            </tr>
                            </thead>
                            <tbody>
                            <!-- Loop through rows in table -->
                            {% for row in table %}
                                <!--
                                Prepare table for display
                                    caution: grade number needs "~" format step to force type to string
                                -->
                                <tr>
                                    <td>{{ row['userID'] }}</td>
                                    <td>{{ row['name'] }}</td>
                                    <td>{{ row['grade'] }}</td>
                                    <td>{{ row['advice'] }}</td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>


        <div class="container py-4">
            <div class="p-5 mb-4 bg-light text-dark rounded-3">
                <h2>Create a new record</h2>
                <form method="POST" ID="create" action={{url_for('crud.create')}} >
                    <table class="table">
                        <thead>
                        <tr>
                            <th><label for="name">Name</label></th>
                            <th><label for="grade">Grade</label></th>
                            <th><label for="advice">Advice</label></th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr>
                            <td><input type="text" name="name" id="name" required></td>
                            <td><input type="text" name="grade" pattern="[0-2|9]{0,2}" id="grade" required></td>
                            <td><input type="text" name="advice" id="advice" required></td>
                            <td><input type="submit" value="Create"></td>
                        </tr>
                        </tbody>
                    </table>
                    <p id="pswError"></p>
                </form>
            </div>

        </div>

        <div class="container py-4">

            <div class="row mb-4 bg-light text-dark rounded-3">

                <div class="col-md-3">
                    <div class="p-5 mb-4 bg-light text-dark rounded-3">
                        <h2>Read</h2>
                        <form method="POST" ID="read" action={{url_for('crud.read')}} >
                            <table id="read_table">
                                <tr><th><label for="read_userid">ID</label></th></tr>
                                <tr>
                                    <td>
                                        <select name="userid" id="read_userid">
                                            <optgroup label="userid">
                                                {% for row in table %}
                                                    <option label="{{ row['userID'] }}">{{ row['userID'] }}</option>
                                                {% endfor %}
                                            </optgroup>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="submit" value="Read">
                                    </td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="p-5 mb-4 bg-light text-dark rounded-3">
                        <h2>Update</h2>
                        <form method="POST" ID="update" action={{url_for('crud.update')}} >
                            <table id="update_table">
                                <tr>
                                    <th><label for="update_userid">ID</label></th>
                                    <th><label for="update_name">Name</label></th>
                                </tr>
                                <tr>
                                    <td>
                                        <select name="userid" id="update_userid">
                                            <optgroup label="userid">
                                                {% for row in table %}
                                                    <option label="{{ row['userID'] }}">{{ row['userID'] }}</option>
                                                {% endfor %}
                                            </optgroup>
                                        </select>
                                    </td>
                                    <td><input type="text" name="name" id="update_name" required></td>
                                    <td><input type="submit" value="Update"></td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="p-5 mb-4 bg-light text-dark rounded-3">
                        <h2>Delete</h2>
                        <form method="POST" ID="read" action={{url_for('crud.delete')}} >
                            <table id="read_table">
                                <tr><th><label for="delete_userid">ID</label></th></tr>
                                <tr>
                                    <td>
                                        <select name="userid" id="delete_userid">
                                            <optgroup label="userid">
                                                {% for row in table %}
                                                    <option label="{{ row['userID'] }}">{{ row['userID'] }}</option>
                                                {% endfor %}
                                            </optgroup>
                                        </select>
                                    </td>
                                    <td><input type="submit" value="Delete"></td>
                                </tr>
                            </table>
                        </form>
                    </div>
                </div>

            </div>

        </div>

    </div>

    <div class="container py-3">
    <h1>Search for some advice</h1>
        <div class="row">
            <div class="col">
                <div class="mb-3">
                    <div class="form-group">
                        <input type="text" class="form-control" id="term" placeholder="enter search term">
                        <label></label> <!-- used for spacer -->
                    </div>
                    <button class="btn btn-primary bg-secondary" onclick="search_data();">Search</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4 bg-light text-dark rounded-3">
            <div class="row">
                <h2 id="result"></h2>
            </div>
        </div>
    </div>
    </div>
    <script>
        function search_data() {
            // fetch standard requires data set to a name-value pair
            const term = document.getElementById("term");
            const body = {
                term: term.value
            };

            // fetch call with header options
            fetch('/crud/search/term/', {
                method: "POST",
                credentials: "include",
                body: JSON.stringify(body),
                cache: "no-cache",
                headers: new Headers({
                    "content-type": "application/json"
                })
            })
                // async then replies with response header
                .then(function (response) {
                    // prepare HTML search result container for new output
                    const resultContainer = document.getElementById("result");
                    // clean up from previous search
                    while (resultContainer.firstChild) {
                        resultContainer.removeChild(resultContainer.firstChild);
                    }
                    // trap error response from Web API
                    if (response.status !== 200) {
                        const errorMsg = 'Database response error: ' + response.status;
                        console.log(errorMsg);
                        const div = document.createElement("div");
                        div.innerHTML = errorMsg;
                        resultContainer.appendChild(div);
                        return;
                    }
                    // response contains valid result
                    response.json().then(function(data) {
                        // loop through JSON and build HTML output
                        for (let i = 0; i < data.length; i++) {
                            const div = document.createElement("div");
                            div.innerHTML = data[i].name + ' ' + data[i].email;
                            resultContainer.appendChild(div);
                        }
                    })
                })
        }
    </script>
    <!-- Back end SQL data definition code (SQLalchemy) -->
    <div class="container py-4">
        <h1 id="BE-MODEL">Back End Definition Code (Model) </h1>
        <script src="https://emgithub.com/embed.js?target=https%3A%2F%2Fgithub.com%2Fnighthawkcoders%2Fnighthawk_csp%2Fblob%2Fmaster%2Fcrud%2Fmodel.py&style=github&showBorder=on&showLineNumbers=on&showFileMeta=on&showCopy=on"></script>
    </div>

    <!-- Front End HTML, shows this file -->
    <div class="container py-4">
        <h1 id="FE-VIEW">Front End HTML Code (View) </h1>
        <script src="https://emgithub.com/embed.js?target=https%3A%2F%2Fgithub.com%2Fnighthawkcoders%2Fnighthawk_csp%2Fblob%2Fmaster%2Fcrud%2Ftemplates%2Fcrud%2Fcrud.html&style=github&showBorder=on&showLineNumbers=on&showFileMeta=on&showCopy=on"></script>
    </div>

    <!-- Back Route code -->
    <div class="container py-4">
        <h1 id="BE-CONTROL">Back End Form Request and API Code (Control)</h1>
        <script src="https://emgithub.com/embed.js?target=https%3A%2F%2Fgithub.com%2Fnighthawkcoders%2Fnighthawk_csp%2Fblob%2Fmaster%2Fcrud%2Fapp_crud.py&style=github&showBorder=on&showLineNumbers=on&showFileMeta=on&showCopy=on"></script>
    </div>

{% endblock %}